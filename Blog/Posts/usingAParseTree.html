<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=device-width">
		<title>Using A Parse Tree</title>
		<link rel="stylesheet" type="text/css" href="/Static/main.css">
		<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
		<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
		<link rel="manifest" href="/site.webmanifest">
		<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
		<meta name="msapplication-TileColor" content="#ffc40d">
		<meta name="theme-color" content="#ffffff">		
	</head>
	<body>
<div class="header">
	<div class="header-title">
		<a href="/" class="title-link">
			<h1>gwerren.com</h1>
			<h2>Programming notes and tools...</h2>
		</a>
	</div>
</div>		<div class="main-container">
			<div class="main-section">
				<div class="post-title-section">
					<h1 class="post-title">Using A Parse Tree</h1>
					<span>Mon, 22 Jun 2020</span>
<a href="/Blog/Tags/jsondatamapper" class="tag">JSON Data Mapper</a><a href="/Blog/Tags/csharp" class="tag">C#</a>				</div>
					<div>
						<h2>Posts in This Series</h2>
						<ol class="series-links">
									<li><a href="/Blog/Posts/simpleCSharpTokenizerUsingRegex">Simple C# Tokenizer Using Regex</a></li>
									<li><a href="/Blog/Posts/simpleCSharpParser">Simple C# Parser</a></li>
									<li><span>Using A Parse Tree</span></li>
						</ol>
					</div>
				<h2>Introduction</h2>

<p>I have started building a <a href="/Projects/jsonDataMapper/">JSON data mapper</a> for which I have first <a href="/Projects/jsonDataMapper/spec">defined a simple mapping language</a>.</p>

<p>I have built a <a href="simpleCSharpTokenizerUsingRegex">tokenizer</a> and <a href="simpleCSharpParser">parser</a> for this language so the next step is to use the output of the parser to build the language executor.</p>

<p>The latest code is available as part of my <a href="https://github.com/gwerren/JSuite">JSuite GitHub project</a> with the entry code file currently located <a href="https://github.com/gwerren/JSuite/blob/master/JSuite.Mapping.Parser/Mapper.cs">here</a>.</p>

<h2>Requirements</h2>

<p>The output of the parser is a set of mappings which should be applied one after the other to extract data from a source JSON object and map it onto a target JSON object.</p>

<p>In usage it is likely that the same mapping will be applied many times to different sets of source and target JSON objects. As a result we should generate a mapping executor once from the mapping script which can be applied to may sets of JSON data.</p>

<h2>Execution in Two Parts</h2>

<p>Each mapping statement is split into two main parts</p>

<ul>
<li>A right hand side which defines how to extract data from the source JSON.</li>
<li>A left hand side which defines how to apply the extracted data to the target JSON.</li>
</ul>

<p>Given this we can tackle each part individually. In my implementation I have defined the following two delegates to represent the two parts.</p>

<pre><code>public delegate IEnumerable&lt;ISourceMatch&gt; ExtractFromSource(JObject sourceObject);

public delegate void UpdateTarget(JObject target, ISourceMatch source);
</code></pre>

<p>With <code>ISourceMatch</code> representing a single match in the source, being defined as:</p>

<pre><code>public interface ISourceMatch
{
    JToken Element { get; }

    IReadOnlyDictionary&lt;string, string&gt; VariableValues { get; }
}
</code></pre>

<p>Given these definitions it is pretty simple to define a mapper that uses them:</p>

<pre><code>private class MappingExecutor
{
    private readonly ExtractFromSource extract;
    private readonly UpdateTarget update;

    public MappingExecutor(IParseTree&lt;TokenType, ParserRuleType&gt; mappingDefinition)
    {
        this.extract = mappingDefinition.SourceExtractor();
        this.update = mappingDefinition.TargetUpdater();
    }

    public void Execute(JObject target, JObject source)
    {
        foreach (var extracted in this.extract(source))
            this.update(target, extracted);
    }
}
</code></pre>

<h2>Generating the Execution Methods</h2>

<p>The execution methods are both generated by building up a set of classes based on the parse tree. From each of these sets we then take a single entry method which provides the delegate implementation described above.</p>

<p>I don't intend to go through all the code here since you can see it all on GitHub, currently at:</p>

<ul>
<li><a href="https://github.com/gwerren/JSuite/blob/master/JSuite.Mapping.Parser/Executing/SourceExtractorBuilder.cs">Source Extractor</a></li>
<li><a href="https://github.com/gwerren/JSuite/blob/master/JSuite.Mapping.Parser/Executing/TargetUpdaterBuilder.cs">Target Updater</a></li>
</ul>

<h2>Conclusion</h2>

<p>This is the final step in building a JSON mapping language execution engine in C#.</p>

<p>By splitting the problem into the standard steps (tokenizing, parsing and using the parse tree), it became fairly simple to build up the full solution. At each stage further splitting the problem down into manageable chunks (a basic software development practice) makes each piece easy to reason about and build.</p>
			</div>
<div class="nav-section">
	<div class="nav-sub-section">
		<h2>About</h2>
		<p>
			I am a C# developer and software architect working in the finance sector in Cambridge, England. This is my personal site where I write about things that interest me (when I have the time!).
		</p>
		<p>
			Here you will find personal projects along with blog articles about programming topics that interest me.
		</p>
	</div>
	<div class="nav-sub-section">
		<p>
			<a href="/rss.xml" class="feed-link">Subscribe</a>
			<a href="https://www.linkedin.com/in/gareth-werren" class="linked-in-link">My Profile</a>
			<a href="/Static/cv.pdf" class="cv-link">My CV</a>
		</p>
	</div>
	<div class="nav-sub-section">
		<ul class="nav-project-list">
				<li>
					<div>
						<a href="/Projects/jsonDataMapper" class="nav-project-title-link"><h2>JSON Data Mapper</h2></a>
						<p class="nav-project-description">A C# project for mapping JSON data from a source to a target JSON payload using a custom mapping definition language</p>
					</div>
				</li>
				<li>
					<div>
						<a href="/Projects/multiCaret" class="nav-project-title-link"><h2>Multi-Caret</h2></a>
						<p class="nav-project-description">A Visual Studio plugin for multi-point editing</p>
					</div>
				</li>
		</ul>
	</div>
	<div class="nav-sub-section">
		<h2>Post Tags</h2>
		<div class="nav-tags">
<a href="/Blog/Tags/csharp" class="tag">C#</a><a href="/Blog/Tags/cast" class="tag">Cast</a><a href="/Blog/Tags/exceptions" class="tag">Exceptions</a><a href="/Blog/Tags/hangfire" class="tag">HangFire</a><a href="/Blog/Tags/jsondatamapper" class="tag">JSON Data Mapper</a><a href="/Blog/Tags/linq" class="tag">Linq</a><a href="/Blog/Tags/mercurial" class="tag">Mercurial</a><a href="/Blog/Tags/multicaret" class="tag">Multi-Caret</a><a href="/Blog/Tags/mvvm" class="tag">MVVM</a><a href="/Blog/Tags/regex" class="tag">Regex</a><a href="/Blog/Tags/servicebus" class="tag">Service Bus</a><a href="/Blog/Tags/textparsing" class="tag">Text Parsing</a><a href="/Blog/Tags/visualstudio" class="tag">Visual Studio</a><a href="/Blog/Tags/wpf" class="tag">WPF</a>		</div>
	</div>
	<div class="nav-sub-section">
		<h2>Latest Blog Posts</h2>
		<ul class="no-bullets">
				<li><a href="/Blog/Posts/usingAParseTree" class="list-link">Using A Parse Tree</a></li>
				<li><a href="/Blog/Posts/simpleCSharpParser" class="list-link">Simple C# Parser</a></li>
				<li><a href="/Blog/Posts/simpleCSharpTokenizerUsingRegex" class="list-link">Simple C# Tokenizer Using Regex</a></li>
				<li><a href="/Blog/Posts/hangfireAsAServiceBus" class="list-link">HangFire as a Service Bus</a></li>
				<li><a href="/Blog/Posts/mercurialCsvLog" class="list-link">Mercurial CSV Log</a></li>
				<li><a href="/Blog/Posts/mvvmCodeBehind" class="list-link">MVVM and Code Behind</a></li>
				<li><a href="/Blog/Posts/introducingMultiCaret" class="list-link">Introducing Multi-Caret</a></li>
			<li class="spacing-item"></li>
			<li><a href="/AllPosts">All Posts...</a></li>
		</ul>
	</div>
</div>		</div>
	</body>
</html>